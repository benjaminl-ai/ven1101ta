<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VEN1101 TA Challenges - Arcade Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --arc-red: #ff3e3e;
            --arc-yellow: #f8e71c;
            --arc-blue: #4a90e2;
            --arc-dark: #121212;
        }
        body { 
            font-family: 'Oswald', 'Noto Sans TC', sans-serif; 
            background: var(--arc-dark); margin: 0; padding: 0; color: #fff; overflow: hidden;
        }

        /* Arcade Header with HP Bars */
        .arcade-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; background: #000; border-bottom: 4px solid var(--arc-yellow);
        }
        .hp-container { width: 40%; }
        .hp-bar { height: 20px; background: #555; border: 2px solid #fff; position: relative; }
        .hp-fill { height: 100%; width: 100%; background: linear-gradient(to bottom, #f8e71c, #d4af37); transition: 0.5s; }
        .vs-text { font-size: 24px; color: var(--arc-red); font-style: italic; font-weight: 900; }

        .page { display: none; height: 100dvh; padding: 10px; flex-direction: column; box-sizing: border-box; }
        .page.active { display: flex; }

        /* Menu Styles */
        .menu-list { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 20px auto; }
        .arc-btn {
            background: linear-gradient(to right, #333, #000);
            border: 3px solid #fff; color: #fff; padding: 15px;
            cursor: pointer; text-align: left; position: relative; overflow: hidden;
            font-size: 16px; transition: 0.2s;
        }
        .arc-btn:active { background: var(--arc-red); transform: translateX(10px); }
        .arc-btn small { display: block; font-size: 13px; color: var(--arc-yellow); }

        /* Game Content */
        .game-box { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .stage-img { width: 100%; height: 150px; border: 3px solid #fff; background: #333; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .stage-img img { max-width: 100%; max-height: 100%; }

        .word-bin { min-height: 60px; border: 2px solid var(--arc-blue); padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; background: rgba(0,0,0,0.6); }
        .chip { background: var(--arc-yellow); color: #000; padding: 8px 12px; font-weight: bold; border-radius: 4px; cursor: pointer; box-shadow: 3px 3px 0 var(--arc-red); }

        /* Control Buttons */
        .ctrl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .main-btn {
            background: var(--arc-red); border: 3px solid #fff; color: #fff; padding: 12px;
            font-size: 14px; font-weight: bold; cursor: pointer; text-align: center;
        }
        .main-btn.hint { background: var(--arc-blue); }
        .main-btn small { display: block; font-size: 11px; opacity: 0.8; }

        /* Popups */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; }
        .ko-box { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 101; text-align: center; width: 90%;
        }
        .ko-text { font-size: 60px; font-weight: 900; color: var(--arc-yellow); text-shadow: 4px 4px var(--arc-red); font-style: italic; }
        
        .bilingual-box { background: #fff; color: #000; padding: 15px; border: 4px solid var(--arc-yellow); font-size: 16px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div id="page-home" class="page active">
    <div style="text-align:center; padding: 20px;">
        <h1 style="font-size: 32px; color: var(--arc-yellow); text-shadow: 3px 3px var(--arc-red);">ARCADE TA<br>CHALLENGE</h1>
    </div>
    <div class="menu-list">
        <div class="arc-btn" onclick="selectTask(1)">
            REMOVING A LIGHT SWITCH
            <small>ç¬¬ä¸€éšæ®µï¼šæ‹†å¸é›»ç‡ˆé–‹é—œ</small>
        </div>
        <div class="arc-btn" onclick="selectTask(2)">
            DRILLING HOLES ON STEEL BOX
            <small>ç¬¬äºŒéšæ®µï¼šåœ¨é‹¼ç®±é‘½å­”</small>
        </div>
    </div>
</div>

<div id="page-levels" class="page">
    <div class="main-btn" style="width: 80px;" onclick="backToHome()">BACK<br><small>è¿”å›</small></div>
    <h2 style="text-align:center; color: var(--arc-yellow);">SELECT STAGE</h2>
    <div class="menu-list">
        <div class="arc-btn" onclick="startL(1)">WORLD 1: BUILDING<small>çµ„å¥è¨“ç·´</small></div>
        <div class="arc-btn" onclick="startL(2)">WORLD 2: SPEAKING<small>è½èªªæŒ‘æˆ°</small></div>
        <div class="arc-btn" onclick="startL(3)">WORLD 3: EXPERT<small>çµ‚æ¥µæ’è§£</small></div>
    </div>
</div>

<div id="page-practice" class="page">
    <div class="arcade-header">
        <div class="hp-container">
            <div style="font-size:10px;">STUDENT HP</div>
            <div class="hp-bar"><div id="hp-player" class="hp-fill"></div></div>
        </div>
        <div class="vs-text">VS</div>
        <div class="hp-container">
            <div style="font-size:10px; text-align:right;">TASK HP</div>
            <div class="hp-bar"><div id="hp-enemy" class="hp-fill" style="background: var(--arc-red);"></div></div>
        </div>
    </div>
    <div id="main-content" class="game-box"></div>
</div>

<div class="overlay" id="overlay"></div>
<div id="ko-box" class="ko-box">
    <div id="ko-title" class="ko-text">K.O.</div>
    <div id="ko-desc" class="bilingual-box"></div>
    <div class="main-btn" onclick="closePopup()" style="margin-top:20px;">CONTINUE / ç¹¼çºŒ</div>
</div>

<script>
    let currentTask = 1, currentL = 1, currentStep = 0, qCount = 0, currentQ = null, isMicOn = false, shouldAutoNext = false;
    let shuffledL3 = [];

    const tasksData = {
        1: {
            title: "TASK 1: LIGHT SWITCH",
            steps: [
                { img: "lightswitch1.jpg", correct: "First, switch off the main power.", chi: "é¦–å…ˆï¼Œé—œæ‰ç¸½é›»æºã€‚", pool: ["First,", "switch off", "the", "main power.", "turn on"] },
                { img: "lightswitch2.jpg", correct: "Next, remove the screws with a screwdriver.", chi: "æ¥è‘—ï¼Œç”¨èºçµ²æ‰¹æ‹†é™¤èºçµ²ã€‚", pool: ["Next,", "remove", "the screws", "with", "a screwdriver.", "install"] },
                { img: "lightswitch3.jpg", correct: "Finally, remove the light switch from the wall.", chi: "æœ€å¾Œï¼Œå¾ç‰†ä¸Šæ‹†ä¸‹é›»ç‡ˆé–‹é—œã€‚", pool: ["Finally,", "remove", "the light switch", "from", "the wall."] }
            ],
            trouble: [
                { q: "What should I do if the screwdriver is rusted?", a: "remove the rust", chi: "å¦‚æœèºçµ²æ‰¹ç”Ÿé½äº†ï¼Œç”¨ç ‚ç´™é™¤é½ã€‚" },
                { q: "What should I do if the screwdriver bit doesn't fit?", a: "use another one", chi: "å¦‚æœæ‰¹é ­ä¸åˆé©ï¼Œæ›å¦ä¸€å€‹ä½¿ç”¨ã€‚" },
                { q: "What should I do if the screws are bent?", a: "use new ones", chi: "å¦‚æœèºçµ²å½æ›²äº†ï¼Œä½¿ç”¨æ–°çš„èºçµ²ã€‚" },
                { q: "What should I do if the light switch is damaged?", a: "replace it", chi: "å¦‚æœé›»ç‡ˆé–‹é—œæå£äº†ï¼Œæ›´æ›å®ƒã€‚" }
            ],
            ts_note: "1. If the screwdriver is rusted, use sandpaper.<br>2. If the bit doesn't fit, use another one.<br>3. If screws are bent, use new ones.<br>4. If switch is damaged, replace it."
        },
        2: {
            title: "TASK 2: STEEL BOX",
            steps: [
                { img: "drill1.jpg", correct: "First, measure the steel box with a tape measure.", chi: "é¦–å…ˆï¼Œç”¨æ²å°ºæ¸¬é‡é‹¼ç®±ã€‚", pool: ["First,", "measure", "the steel box", "with", "a tape measure."] },
                { img: "drill2.jpg", correct: "Next, mark the spots with a marker.", chi: "æ¥è‘—ï¼Œç”¨æ¨™è¨˜ç­†æ¨™è¨˜ä½ç½®ã€‚", pool: ["Next,", "mark", "the spots", "with", "a marker."] },
                { img: "drill3.jpg", correct: "Finally, drill holes with a power drill.", chi: "æœ€å¾Œï¼Œç”¨é›»é‘½é‘½å­”ã€‚", pool: ["Finally,", "drill", "holes", "with", "a power drill."] }
            ],
            trouble: [
                { q: "What should I do if the drill bit is broken?", a: "replace it", chi: "å¦‚æœé‘½é ­æ–·äº†ï¼Œæ›´æ›å®ƒã€‚" },
                { q: "What should I do if the power drill doesn't work?", a: "check the battery", chi: "å¦‚æœé›»é‘½ç„¡æ³•é‹ä½œï¼Œæª¢æŸ¥é›»æ± ã€‚" },
                { q: "What should I do if the drill bit is rusted?", a: "clean it with sandpaper", chi: "å¦‚æœé‘½é ­ç”Ÿé½äº†ï¼Œç”¨ç ‚ç´™æ¸…æ½”ã€‚" },
                { q: "What should I do if the drill bit doesn't fit?", a: "choose another one", chi: "å¦‚æœé‘½é ­ä¸åˆé©ï¼Œé¸æ“‡å¦ä¸€å€‹ä½¿ç”¨ã€‚" }
            ],
            ts_note: "1. If bit is broken, replace it.<br>2. If drill fails, check battery.<br>3. If bit is rusted, clean it.<br>4. If bit doesn't fit, choose another one."
        }
    };

    function selectTask(tid) { currentTask = tid; document.getElementById('page-home').classList.remove('active'); document.getElementById('page-levels').classList.add('active'); }
    function backToHome() { document.getElementById('page-levels').classList.remove('active'); document.getElementById('page-home').classList.add('active'); }
    function backToLevels() { stopMic(); document.getElementById('page-practice').classList.remove('active'); document.getElementById('page-levels').classList.add('active'); }

    function startL(l) { 
        currentL = l; currentStep = 0; qCount = 0;
        if (l === 3) shuffledL3 = [...tasksData[currentTask].trouble].sort(() => Math.random() - 0.5);
        document.getElementById('page-levels').classList.remove('active'); 
        document.getElementById('page-practice').classList.add('active'); 
        render(); 
    }

    function render() {
        const m = document.getElementById('main-content');
        const data = tasksData[currentTask];
        shouldAutoNext = false;
        updateHP(100);

        if (currentL === 1) {
            const d = data.steps[currentStep];
            m.innerHTML = `<div class="stage-img"><img src="${d.img}"></div><div class="word-bin" id="dz"></div><div class="word-bin" id="pool" style="border:none;"></div><div class="ctrl-grid"><div class="main-btn hint" onclick="showHint('${d.chi}')">HINT<small>æç¤º</small></div><div class="main-btn" onclick="checkL1()">CHECK<small>æª¢æŸ¥</small></div></div>`;
            const dz = document.getElementById('dz'), pool = document.getElementById('pool');
            [...d.pool].sort(() => Math.random() - 0.5).forEach(w => {
                const s = document.createElement('span'); s.className = 'chip'; s.innerText = w;
                s.onclick = () => { s.parentNode === pool ? dz.appendChild(s) : pool.appendChild(s); };
                pool.appendChild(s);
            });
        } else if (currentL === 2) {
            const d = data.steps[currentStep];
            m.innerHTML = `<div class="stage-img"><img src="${d.img}"></div><div class="bilingual-box" style="background:#000; color:#fff; border-color:var(--arc-blue);"><p style="color:var(--arc-yellow); margin:0;">${d.correct}</p><p style="margin:5px 0 0 0; font-size:14px; opacity:0.8;">${d.chi}</p></div><div class="ctrl-grid"><div class="main-btn hint" onclick="speak('${d.correct}')">LISTEN<small>è½ç¤ºç¯„</small></div><div id="rec-btn" class="main-btn" onclick="rec('${d.correct}', this)">SPEAK<small>éŒ„éŸ³</small></div></div>`;
        } else if (currentL === 3) {
            currentQ = shuffledL3[qCount];
            m.innerHTML = `<div class="stage-img" onclick="speak(currentQ.q)" style="cursor:pointer; flex-direction:column; background:var(--arc-red);"><div>ğŸ”Š ENEMY QUESTION</div><small>è½å®¢æˆ¶å•é¡Œ</small></div><div class="bilingual-box" style="font-size:13px; max-height:120px; overflow-y:auto;">${data.ts_note}</div><div id="rec-btn" class="main-btn" onclick="rec(currentQ.a, this)">ANSWER<small>éŒ„éŸ³å›ç­”</small></div>`;
        }
    }

    function updateHP(p) { 
        let enemyHP = 100 - (currentL === 3 ? (qCount / 4 * 100) : (currentStep / 3 * 100));
        document.getElementById('hp-enemy').style.width = enemyHP + "%"; 
    }

    function showHint(txt) { showKO("HINT", txt, false); }

    function checkL1() {
        const d = tasksData[currentTask].steps[currentStep];
        const ans = Array.from(document.getElementById('dz').querySelectorAll('.chip')).map(e => e.innerText).join(" ");
        if (ans.toLowerCase().replace(/[ ,.]/g,'') === d.correct.toLowerCase().replace(/[ ,.]/g,'')) {
            fireConfetti(); shouldAutoNext = true;
            showKO("PERFECT", `${d.correct}<br><br>${d.chi}`, true);
        } else { showKO("MISS", "Wrong sequence! Try again.", false); }
    }

    function showKO(title, desc, isSuccess) {
        document.getElementById('ko-title').innerText = title;
        document.getElementById('ko-desc').innerHTML = desc;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('ko-box').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('ko-box').style.display = 'none';
        if(shouldAutoNext) {
            if(currentL === 1) { currentStep++; if(currentStep > 2) { currentStep = 0; currentL = 2; } render(); }
            else if(currentL === 2) { currentStep++; if(currentStep > 2) { currentStep = 0; currentL = 3; } render(); }
            else if(currentL === 3) { qCount++; if(qCount >= 4) { fireConfetti(); showKO("WINNER", "All tasks cleared!", true); backToHome(); } else render(); }
        }
    }

    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'en-US'; window.speechSynthesis.speak(m); }

    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    const recognition = (SpeechRecognition) ? new SpeechRecognition() : null;
    if (recognition) { recognition.lang = 'en-US'; }

    function rec(target, btn) {
        if(!recognition || isMicOn) return;
        isMicOn = true; btn.innerHTML = "FIGHTING...<small>éŒ„éŸ³ä¸­</small>";
        recognition.start();
        recognition.onresult = (e) => {
            const res = e.results[0][0].transcript.toLowerCase();
            stopMic();
            let isCorrect = res.includes(target.toLowerCase().replace(/[.,!]/g, ''));
            if(isCorrect) { fireConfetti(); shouldAutoNext = true; showKO("K.O.", "Excellent Strike!", true); }
            else { showKO("BLOCK", `You said: "${res}"`, false); }
        };
        recognition.onspeechend = stopMic;
    }

    function stopMic() { isMicOn = false; const btn = document.getElementById('rec-btn'); if (btn) btn.innerHTML = (currentL === 3) ? "ANSWER<small>å›ç­”</small>" : "SPEAK<small>éŒ„éŸ³</small>"; if(recognition) recognition.stop(); }
    function fireConfetti() { confetti({ particleCount: 150, spread: 100, origin: { y: 0.5 } }); }
</script>
</body>
</html>
