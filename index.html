<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VEN1101 TA Challenges - RPG Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --rpg-blue: linear-gradient(180deg, #0000ad 0%, #00004a 100%);
            --rpg-border: #fff;
            --rpg-shadow: #555;
            --m-yellow: #f8d878;
        }
        body { 
            font-family: 'Poppins', 'Noto Sans TC', sans-serif; 
            background-color: #222; 
            margin: 0; padding: 0; color: #fff; overflow: hidden;
        }
        
        /* ç¶“å…¸ RPG è—è‰²å°è©±æ¡†èƒŒæ™¯ */
        .rpg-box {
            background: var(--rpg-blue);
            border: 3px solid var(--rpg-border);
            border-radius: 8px;
            box-shadow: 0 0 0 2px #000, 4px 4px 10px rgba(0,0,0,0.5);
            padding: 15px;
            box-sizing: border-box;
        }

        .page { display: none; height: 100dvh; padding: 15px; flex-direction: column; }
        .page.active { display: flex; }

        /* Header */
        .header-area { text-align: center; margin-bottom: 20px; }
        .header-area h1 { font-size: 22px; margin: 0; letter-spacing: 1px; color: #fff; }
        .header-area .sub-text { font-size: 14px; color: var(--m-yellow); font-weight: bold; }

        /* Menu List - ä»¿é¸å–®æ‰‹æŒ‡æŒ‡å‘æ•ˆæœ */
        .menu-list { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 400px; margin: 0 auto; }
        .rpg-item { 
            background: rgba(0,0,0,0.3); border: 2px solid transparent;
            padding: 15px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px;
        }
        .rpg-item:hover, .rpg-item:active { 
            border-color: var(--rpg-border); background: rgba(255,255,255,0.1);
        }
        .rpg-item::before { content: "â–¶"; color: #fff; font-size: 12px; }

        /* Practice Area */
        .content-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .img-container { width: 100%; height: 150px; background: #000; border: 2px solid #fff; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; }
        .img-container img { max-width: 100%; max-height: 100%; }

        /* Word Blocks */
        .word-area { background: rgba(0,0,0,0.5); border: 1px solid #777; padding: 10px; min-height: 50px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .word-chip { 
            background: #eee; color: #000; padding: 8px 12px; border-radius: 4px; 
            font-weight: bold; font-size: 14px; cursor: pointer; border-bottom: 3px solid #999;
        }
        .word-chip:active { transform: translateY(2px); border-bottom: 1px solid #999; }

        /* RPG Buttons */
        .btn-rpg {
            background: var(--rpg-blue); border: 2px solid #fff; color: #fff;
            padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
            font-weight: bold; width: 100%; margin-top: 10px; text-align: center;
        }
        .btn-rpg:active { background: #00004a; }
        .btn-rpg span { display: block; font-size: 12px; opacity: 0.8; margin-top: 2px; }

        /* Progress Bar */
        .prog-track { width: 100%; height: 15px; background: #333; border: 2px solid #fff; margin-top: 20px; position: relative; border-radius: 10px; }
        .prog-fill { height: 100%; width: 0%; background: #00ff00; border-radius: 8px; transition: 0.5s; }
        .prog-char { position: absolute; top: -25px; right: -10px; font-size: 20px; transition: 0.5s; }

        .note-text { font-size: 13px; line-height: 1.6; color: #fff; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="page-home" class="page active">
    <div class="header-area">
        <h1 class="rpg-box">VEN1101 TA CHALLENGES</h1>
        <div class="sub-text" style="margin-top:15px;">Building Services Engineering<br>å±‹å®‡è£å‚™å·¥ç¨‹</div>
    </div>
    <div class="menu-list">
        <div class="rpg-item rpg-box" onclick="selectTask(1)">
            <div>REMOVING A LIGHT SWITCH<br><small>ç¬¬ä¸€éšæ®µï¼šæ‹†å¸é›»ç‡ˆé–‹é—œ</small></div>
        </div>
        <div class="rpg-item rpg-box" onclick="selectTask(2)">
            <div>DRILLING HOLES ON STEEL BOX<br><small>ç¬¬äºŒéšæ®µï¼šåœ¨é‹¼ç®±é‘½å­”</small></div>
        </div>
    </div>
</div>

<div id="page-levels" class="page">
    <button onclick="backToHome()" class="btn-rpg" style="width:auto; padding: 5px 15px;">BACK / è¿”å›</button>
    <div class="header-area" style="margin-top:20px;">
        <h2 id="task-title" style="color:var(--m-yellow);"></h2>
    </div>
    <div class="menu-list">
        <div class="rpg-item rpg-box" onclick="startL(1)">WORLD 1: BUILDING / çµ„å¥ç·´ç¿’</div>
        <div class="rpg-item rpg-box" onclick="startL(2)">WORLD 2: SPEAKING / è½èªªç·´ç¿’</div>
        <div class="rpg-item rpg-box" onclick="startL(3)">WORLD 3: EXPERT / æ•…éšœæ’é™¤</div>
    </div>
</div>

<div id="page-practice" class="page">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <button onclick="backToLevels()" class="btn-rpg" style="width:auto; padding: 5px 15px; margin:0;">EXIT / é›¢é–‹</button>
        <span id="level-indicator" style="color:var(--m-yellow); font-weight:bold; font-size:12px;"></span>
    </div>
    <div id="main-content" class="content-area rpg-box"></div>
    <div class="prog-track">
        <div id="progress-bar" class="prog-fill">
            <span class="prog-char">âš”ï¸</span>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div class="popup rpg-box" id="popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; z-index:200; text-align:center;">
    <div id="pop-icon" style="font-size:30px; margin-bottom:10px;"></div>
    <div id="pop-text" style="font-size:14px; margin-bottom:20px;"></div>
    <button class="btn-rpg" onclick="closePopup()">CONTINUE / ç¹¼çºŒ</button>
</div>

<script>
    let currentTask = 1, currentL = 1, currentStep = 0, qCount = 0, currentQ = null, isMicOn = false, shouldAutoNext = false;
    let shuffledL3 = [];

    const tasksData = {
        1: {
            title: "TASK 1: LIGHT SWITCH",
            steps: [
                { img: "lightswitch1.jpg", correct: "First, switch off the main power.", chi: "é¦–å…ˆï¼Œé—œæ‰ç¸½é›»æºã€‚", pool: ["First,", "switch off", "the", "main power.", "turn on", "connect"] },
                { img: "lightswitch2.jpg", correct: "Next, remove the screws with a screwdriver.", chi: "æ¥è‘—ï¼Œç”¨èºçµ²æ‰¹æ‹†é™¤èºçµ²ã€‚", pool: ["Next,", "remove", "the screws", "with", "a screwdriver.", "install"] },
                { img: "lightswitch3.jpg", correct: "Finally, remove the light switch from the wall.", chi: "æœ€å¾Œï¼Œå¾ç‰†ä¸Šæ‹†ä¸‹é›»ç‡ˆé–‹é—œã€‚", pool: ["Finally,", "remove", "the light switch", "from", "the wall.", "put"] }
            ],
            trouble: [
                { q: "What should I do if the screwdriver is rusted?", a: "remove the rust", full: "You should remove the rust with sandpaper.", chi: "å¦‚æœèºçµ²æ‰¹ç”Ÿé½äº†ï¼Œç”¨ç ‚ç´™é™¤é½ã€‚" },
                { q: "What should I do if the screwdriver bit doesn't fit?", a: "use another one", full: "You should use another one.", chi: "å¦‚æœæ‰¹é ­ä¸åˆé©ï¼Œæ›å¦ä¸€å€‹ä½¿ç”¨ã€‚" },
                { q: "What should I do if the screws are bent?", a: "use new ones", full: "You should use new ones.", chi: "å¦‚æœèºçµ²å½æ›²äº†ï¼Œä½¿ç”¨æ–°çš„èºçµ²ã€‚" },
                { q: "What should I do if the light switch is damaged?", a: "replace it", full: "You should replace it.", chi: "å¦‚æœé›»ç‡ˆé–‹é—œæå£äº†ï¼Œæ›´æ›å®ƒã€‚" }
            ],
            ts_note: "1. If the screwdriver is rusted, remove the rust with sandpaper.<br><br>2. If the screwdriver bit doesn't fit, use another one.<br><br>3. If the screws are bent, use new ones.<br><br>4. If the light switch is damaged, replace it."
        },
        2: {
            title: "TASK 2: STEEL BOX",
            steps: [
                { img: "drill1.jpg", correct: "First, measure the steel box with a tape measure.", chi: "é¦–å…ˆï¼Œç”¨æ²å°ºæ¸¬é‡é‹¼ç®±ã€‚", pool: ["First,", "measure", "the steel box", "with", "a tape measure.", "cut"] },
                { img: "drill2.jpg", correct: "Next, mark the spots with a marker.", chi: "æ¥è‘—ï¼Œç”¨æ¨™è¨˜ç­†æ¨™è¨˜ä½ç½®ã€‚", pool: ["Next,", "mark", "the spots", "with", "a marker.", "drill"] },
                { img: "drill3.jpg", correct: "Finally, drill holes with a power drill.", chi: "æœ€å¾Œï¼Œç”¨é›»é‘½é‘½å­”ã€‚", pool: ["Finally,", "drill", "holes", "with", "a power drill.", "screw"] }
            ],
            trouble: [
                { q: "What should I do if the drill bit is broken?", a: "replace it", full: "If the drill bit is broken, replace it.", chi: "å¦‚æœé‘½é ­æ–·äº†ï¼Œæ›´æ›å®ƒã€‚" },
                { q: "What should I do if the power drill doesn't work?", a: "check the battery", full: "If the power drill doesn't work, check the battery.", chi: "å¦‚æœé›»é‘½ç„¡æ³•é‹ä½œï¼Œæª¢æŸ¥é›»æ± ã€‚" },
                { q: "What should I do if the drill bit is rusted?", a: "clean it with sandpaper", full: "If the drill bit is rusted, clean it with sandpaper.", chi: "å¦‚æœé‘½é ­ç”Ÿé½äº†ï¼Œç”¨ç ‚ç´™æ¸…æ½”ã€‚" },
                { q: "What should I do if the drill bit doesn't fit?", a: "choose another one", full: "If the drill bit doesn't fit, choose another one.", chi: "å¦‚æœé‘½é ­ä¸åˆé©ï¼Œé¸æ“‡å¦ä¸€å€‹ä½¿ç”¨ã€‚" }
            ],
            ts_note: "1. If the drill bit is broken, replace it.<br><br>2. If the power drill doesn't work, check the battery.<br><br>3. If the drill bit is rusted, clean it with sandpaper.<br><br>4. If the drill bit doesn't fit, choose another one."
        }
    };

    function selectTask(tid) { currentTask = tid; document.getElementById('task-title').innerText = tasksData[tid].title; document.getElementById('page-home').classList.remove('active'); document.getElementById('page-levels').classList.add('active'); }
    function backToHome() { document.getElementById('page-levels').classList.remove('active'); document.getElementById('page-home').classList.add('active'); }
    function backToLevels() { stopMic(); document.getElementById('page-practice').classList.remove('active'); document.getElementById('page-levels').classList.add('active'); }
    
    function startL(l) { 
        currentL = l; currentStep = 0; qCount = 0;
        if (l === 3) shuffledL3 = [...tasksData[currentTask].trouble].sort(() => Math.random() - 0.5);
        document.getElementById('page-levels').classList.remove('active'); 
        document.getElementById('page-practice').classList.add('active'); 
        render(); 
    }

    function render() {
        const m = document.getElementById('main-content');
        const ind = document.getElementById('level-indicator');
        const data = tasksData[currentTask];
        shouldAutoNext = false;

        if (currentL === 1) {
            updateProgress(currentStep / 3 * 100);
            ind.innerHTML = `WORLD 1: BUILDING`;
            const d = data.steps[currentStep]; 
            m.innerHTML = `<div class="img-container"><img src="${d.img}"></div><div class="word-area" id="dz"></div><div class="word-area" id="pool" style="background:none; border:none;"></div><button class="btn-rpg" onclick="showHint('${d.chi}')">HINT<span>æç¤º</span></button><button class="btn-rpg" onclick="checkL1()">CHECK<span>æª¢æŸ¥ç­”æ¡ˆ</span></button>`;
            const dz = document.getElementById('dz'); const pool = document.getElementById('pool');
            [...d.pool].sort(() => Math.random() - 0.5).forEach(w => {
                const s = document.createElement('span'); s.className = 'word-chip'; s.innerText = w;
                s.onclick = () => { if (s.parentNode === pool) dz.appendChild(s); else pool.appendChild(s); };
                pool.appendChild(s);
            });
        } else if (currentL === 2) {
            updateProgress(currentStep / 3 * 100);
            ind.innerHTML = `WORLD 2: SPEAKING`;
            const d = data.steps[currentStep];
            m.innerHTML = `<div class="img-container"><img src="${d.img}"></div><p style="font-weight:bold; color:var(--m-yellow); text-align:center; font-size:16px;">${d.correct}</p><p style="text-align:center; font-size:14px; opacity:0.9;">${d.chi}</p><button class="btn-rpg" onclick="speak('${d.correct}')">LISTEN<span>è½ç¤ºç¯„</span></button><button id="rec-btn" class="btn-rpg" onclick="rec('${d.correct}', this)">SPEAK<span>é–‹å§‹éŒ„éŸ³</span></button>`;
        } else if (currentL === 3) {
            updateProgress(qCount / 4 * 100);
            ind.innerHTML = `WORLD 3: EXPERT`;
            currentQ = shuffledL3[qCount];
            m.innerHTML = `<div class="img-container" style="cursor:pointer;" onclick="speak(currentQ.q)"><div>ğŸ”Š LISTEN TO QUESTION<span>è½å®¢æˆ¶å•é¡Œ</span></div></div><div class="note-text">${data.ts_note}</div><button id="rec-btn" class="btn-rpg" onclick="rec(currentQ.a, this)">ANSWER<span>éŒ„éŸ³å›ç­”</span></button>`;
        }
    }

    function updateProgress(p) { document.getElementById('progress-bar').style.width = p + "%"; }
    function showHint(txt) { showPop("HINT / æç¤º", "ğŸ’¡", `<div style="font-size:18px;">${txt}</div>`); }

    function checkL1() {
        const d = tasksData[currentTask].steps[currentStep];
        const ans = Array.from(document.getElementById('dz').querySelectorAll('.word-chip')).map(e => e.innerText).join(" ");
        if (ans.toLowerCase().replace(/[ ,.]/g,'') === d.correct.toLowerCase().replace(/[ ,.]/g,'')) {
            fireConfetti(); shouldAutoNext = true;
            showPop("EXCELLENT!", "âš”ï¸", `${d.correct}<br><br>${d.chi}`);
        } else { showPop("MISS!", "â“", "TRY AGAIN / å†è©¦ä¸€æ¬¡"); }
    }

    function nextStep() { currentStep++; if(currentStep > 2) { currentStep = 0; startL(3); } else render(); }
    function randomQ() { qCount++; if(qCount >= 4) { fireConfetti(); showPop("VICTORY!", "ğŸ†", "ALL TASKS COMPLETED / ä»»å‹™å…¨éƒ¨å®Œæˆï¼"); backToHome(); } else render(); }
    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'en-US'; window.speechSynthesis.speak(m); }

    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    const recognition = (SpeechRecognition) ? new SpeechRecognition() : null;
    if (recognition) { recognition.lang = 'en-US'; }

    function rec(target, btn) {
        if(!recognition || isMicOn) return;
        isMicOn = true; btn.innerHTML = "RECORDING...<span>éŒ„éŸ³ä¸­...</span>";
        recognition.start();
        recognition.onresult = (e) => {
            const res = e.results[0][0].transcript.toLowerCase();
            stopMic();
            let cleanT = target.toLowerCase().replace(/[.,!]/g, '');
            let isCorrect = res.includes(cleanT) || cleanT.includes(res);
            if(isCorrect) { fireConfetti(); shouldAutoNext = true; }
            showPop(isCorrect ? "SUCCESS!" : "MISS!", isCorrect ? "âœ¨" : "ğŸ”¥", isCorrect ? "PERFECT!" : `YOU SAID: "${res}"`);
        };
        recognition.onspeechend = stopMic; recognition.onerror = stopMic;
    }

    function stopMic() { isMicOn = false; const btn = document.getElementById('rec-btn'); if (btn) btn.innerHTML = (currentL === 3) ? "ANSWER<span>éŒ„éŸ³å›ç­”</span>" : "SPEAK<span>é–‹å§‹éŒ„éŸ³</span>"; if(recognition) recognition.stop(); }
    function fireConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
    function showPop(title, icon, text) { document.getElementById('pop-icon').innerText = icon; document.getElementById('pop-text').innerHTML = `<strong>${title}</strong><br><br>${text}`; document.getElementById('overlay').style.display = 'block'; document.getElementById('popup').style.display = 'block'; }
    function closePopup() { 
        document.getElementById('overlay').style.display = 'none'; document.getElementById('popup').style.display = 'none'; 
        if(shouldAutoNext) {
            if(currentL === 1) { currentStep++; if(currentStep > 2) { currentStep = 0; currentL = 2; } render(); }
            else if(currentL === 2) nextStep();
            else if(currentL === 3) randomQ();
        }
    }
</script>
</body>
</html>
